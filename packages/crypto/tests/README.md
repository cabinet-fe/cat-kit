# Crypto 模块测试文档

本目录包含 `@cat-kit/crypto` 包的完整单元测试和集成测试。

## 测试文件说明

### 单元测试

- **key-gen.test.ts** - 生成器模块测试

  - `random()` - 随机数生成
  - `nanoid()` - 唯一 ID 生成
  - `customAlphabet()` - 自定义字符集 ID 生成

- **md5.test.ts** - MD5 摘要算法测试

  - 基本哈希功能
  - 增量哈希器
  - 输出格式（hex/base64/bytes）
  - 边界情况和性能

- **aes.test.ts** - AES 加密算法测试

  - CBC 模式加密/解密
  - 多种密钥长度（128/192/256 位）
  - 多种填充方式（PKCS7/Zero/None）
  - 输出格式
  - 错误处理
  - 安全性测试

- **utils.test.ts** - 工具函数测试

  - 数据类型转换
  - 环境检测

- **types.test.ts** - 类型定义测试
  - HashResult 类
  - CipherResult 类

### 集成测试

- **integration.test.ts** - 综合场景测试
  - 完整加密工作流
  - 数据完整性验证
  - 批量数据处理
  - 性能测试
  - 实际应用场景

## 运行测试

### 运行所有测试

```bash
# 在项目根目录
bun run test

# 或在 crypto 包目录
cd packages/crypto
bun run test
```

### 运行特定测试文件

```bash
bun run test key-gen.test.ts
bun run test md5.test.ts
bun run test aes.test.ts
```

### 监听模式

```bash
bun run test:watch
```

### 生成覆盖率报告

```bash
bun run test:coverage
```

### 使用 UI 界面

```bash
bun run test:ui
```

## 测试覆盖率目标

- **行覆盖率**: > 90%
- **分支覆盖率**: > 85%
- **函数覆盖率**: > 90%
- **语句覆盖率**: > 90%

## 测试用例说明

### 生成器模块测试

1. **功能测试**

   - 生成正确长度的数据
   - 生成唯一的值
   - 支持自定义配置

2. **边界测试**

   - 零长度输入
   - 极大长度输入
   - 单字符字母表

3. **性能测试**
   - 大量 ID 生成性能
   - 随机数生成性能

### MD5 测试

1. **标准测试向量**

   - 使用已知的 MD5 值验证
   - 空字符串
   - 标准测试字符串

2. **增量计算**

   - 分片更新
   - 与一次性计算结果对比

3. **大文件支持**
   - 模拟大数据处理
   - 块边界测试

### AES 测试

1. **加密正确性**

   - 加密/解密往返测试
   - 多种密钥长度
   - 多种填充方式

2. **安全性**

   - 不同 IV 产生不同密文
   - 不同密钥产生不同密文
   - 错误密钥解密失败

3. **边界情况**
   - 空数据
   - 块对齐数据
   - 大数据

## 集成测试场景

1. **完整加密工作流**

   - 密钥生成 → 加密 → 哈希 → 解密 → 验证

2. **数据完整性**

   - 原始数据哈希
   - 密文哈希
   - 解密后验证

3. **实际应用**
   - 密码加密存储
   - 文件完整性校验
   - 会话令牌生成

## 环境要求

- Node.js >= 22
- Bun (推荐)
- Vitest 3.x

## 注意事项

1. **浏览器环境测试**

   - 部分测试在 Node.js 环境运行
   - Web Crypto API 相关测试需要 HTTPS 环境

2. **随机性测试**

   - 随机数相关测试可能有极小概率失败
   - 已设置合理的容错阈值

3. **性能测试**
   - 性能阈值根据本地环境设置
   - CI 环境可能需要调整阈值

## 持续集成

测试应该在以下情况下自动运行：

- 每次 commit
- 每次 pull request
- 每次发布前

## 贡献指南

添加新功能时，请确保：

1. 编写对应的单元测试
2. 测试覆盖率不低于现有水平
3. 所有测试通过
4. 更新此文档
